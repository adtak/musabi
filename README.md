# Musabi

Musabi ã¯ã€AI ã‚’ä½¿ã£ã¦ãƒ¬ã‚·ãƒ”ã®ç”Ÿæˆãƒ»ç”»åƒç”Ÿæˆãƒ»ç”»åƒç·¨é›†ãƒ»SNS æŠ•ç¨¿ã‚’è‡ªå‹•åŒ–ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚AWS Step Functions ã‚’ä½¿ç”¨ã—ã¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ§‹ç¯‰ã—ã€Lambda é–¢æ•°ã¨ Container ã§å„ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     AWS Step Functions                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  GenText  â†’  GenImg  â†’  EditImg  â†’  PubImg                     â”‚
â”‚     â†“         â†“         â†“          â†“                          â”‚
â”‚  OpenAI    DALL-E 3   ç”»åƒç·¨é›†     SNSæŠ•ç¨¿                     â”‚
â”‚  GPT-4       /        ã‚¿ã‚¤ãƒˆãƒ«      (Meta)                     â”‚
â”‚           Stable      è¿½åŠ                                      â”‚
â”‚           Diffusion                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
                          S3 Bucket
                      (ç”»åƒãƒ»ãƒ‡ãƒ¼ã‚¿ä¿å­˜)
```

## ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

### ã‚³ã‚¢ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

- **`lambda/`** - AWS Lambda é–¢æ•°ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
  - `gen_text/` - OpenAI GPT-4 ã‚’ä½¿ç”¨ã—ã¦ãƒ¬ã‚·ãƒ”ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
  - `gen_img/` - DALL-E 3 / Google Gemini ã‚’ä½¿ç”¨ã—ã¦æ–™ç†ç”»åƒã‚’ç”Ÿæˆ
  - `edit_img/` - ç”Ÿæˆã•ã‚ŒãŸç”»åƒã«ã‚¿ã‚¤ãƒˆãƒ«ã‚„ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
  - `pub_img/` - å®Œæˆã—ãŸç”»åƒã¨ãƒ¬ã‚·ãƒ”ã‚’ SNS ã«æŠ•ç¨¿
  - `shared/` - å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆS3ã€ãƒ­ã‚®ãƒ³ã‚°ã€è¨­å®šç®¡ç†ï¼‰

- **`iac-v2/`** - AWS CDK v2 (TypeScript) ã«ã‚ˆã‚‹ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰
  - Step Functionsã€Lambdaã€ECRã€S3 ã®è¨­å®š
  - 12 æ™‚é–“ã”ã¨ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œè¨­å®š
  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ã‚¢ã‚¯ã‚»ã‚¹ç®¡ç†

- **`ml-v2/`** - Stable Diffusion ã‚’ä½¿ç”¨ã—ãŸç”»åƒç”Ÿæˆ
  - SageMaker å‡¦ç†ã‚¸ãƒ§ãƒ–ç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠ
  - ã‚«ã‚¹ã‚¿ãƒ ç”»åƒç”Ÿæˆã¨ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨

- **`util/`** - ç”»åƒãƒ»éŸ³å£°ãƒ»å‹•ç”»å‡¦ç†ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  - ç”»åƒå‡¦ç†ã€éŸ³å£°å‡¦ç†ã€å‹•ç”»ç”Ÿæˆæ©Ÿèƒ½

- **`iac-v1/` & `ml-v1/`** - ãƒ¬ã‚¬ã‚·ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (Python CDK)

## ğŸ”„ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

Step Functions ã§ä»¥ä¸‹ã®é †åºã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™ï¼š

1. **GenText** - OpenAI GPT-4 ã§ç‹¬å‰µçš„ãªãƒ¬ã‚·ãƒ”ã‚’ç”Ÿæˆ
2. **GenImg** - DALL-E 3 ã¾ãŸã¯ Stable Diffusion ã§æ–™ç†ç”»åƒã‚’ç”Ÿæˆ
3. **EditImg** - ç”»åƒã«ã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã‚’è¿½åŠ 
4. **PubImg** - å®Œæˆã—ãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ SNS (Meta) ã«æŠ•ç¨¿

## ğŸ› ï¸ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
- **Language**: Python 3.13, TypeScript
- **Dependency Management**: uv (Python), npm (Node.js)
- **APIs**: OpenAI (GPT-4, DALL-E 3), Google Gemini
- **Cloud**: AWS (Lambda, Step Functions, S3, ECR, SageMaker)

### ã‚¤ãƒ³ãƒ•ãƒ©
- **Infrastructure as Code**: AWS CDK v2
- **Container**: Docker, Amazon ECR
- **Orchestration**: AWS Step Functions
- **Storage**: Amazon S3
- **Scheduling**: Amazon EventBridge

### æ©Ÿæ¢°å­¦ç¿’
- **Frameworks**: PyTorch, Diffusers
- **Models**: Stable Diffusion, DALL-E 3, GPT-4
- **Image Processing**: Pillow (PIL)

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### å‰ææ¡ä»¶

- Python 3.13+
- Node.js 18+
- AWS CLI ã¨èªè¨¼è¨­å®š
- Docker (ml-v2 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç”¨)
- uv (Python dependency manager)

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

1. **ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³**
   ```bash
   git clone https://github.com/adtak/musabi.git
   cd musabi
   ```

2. **Lambda é–¢æ•°ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
   ```bash
   cd lambda
   uv sync
   ```

3. **ã‚¤ãƒ³ãƒ•ãƒ© (CDK) ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
   ```bash
   cd iac-v2
   npm install
   ```

4. **æ©Ÿæ¢°å­¦ç¿’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
   ```bash
   cd ml-v2
   poetry install
   ```

### è¨­å®š

#### AWS SSM ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

ä»¥ä¸‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ AWS Systems Manager Parameter Store ã«è¨­å®šã—ã¦ãã ã•ã„ï¼š

```bash
# OpenAI API ã‚­ãƒ¼
aws ssm put-parameter --name "/openai/musabi/api-key" --value "your-openai-api-key" --type "SecureString"

# Meta (SNS) èªè¨¼æƒ…å ±
aws ssm put-parameter --name "/meta/musabi/access-token" --value "your-meta-access-token" --type "SecureString"
aws ssm put-parameter --name "/meta/musabi/page-id" --value "your-meta-page-id" --type "String"
```

#### ç’°å¢ƒå¤‰æ•°

- `BUCKET_NAME`: S3 ãƒã‚±ãƒƒãƒˆå (edit_img, pub_img ã§ä½¿ç”¨)
- `IMAGE_BUCKET`: ç”»åƒä¿å­˜ç”¨ S3 ãƒã‚±ãƒƒãƒˆ
- `PROMPT`, `NEGATIVE_PROMPT`: ml-v2 ã§ã®ç”»åƒç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

## ğŸ”§ é–‹ç™ºã‚³ãƒãƒ³ãƒ‰

### Lambda é–¢æ•° (`lambda/`)

```bash
# ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
make format

# å‹ãƒã‚§ãƒƒã‚¯
make mypy

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
make test

# å…¨ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯
make format && make mypy && make test
```

### ã‚¤ãƒ³ãƒ•ãƒ© (`iac-v2/`)

```bash
# TypeScript ãƒ“ãƒ«ãƒ‰
npm run build

# ãƒªãƒ³ãƒˆ & ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
npm run lint
npm run fmt

# ãƒ†ã‚¹ãƒˆ
npm test

# CDK ãƒ‡ãƒ—ãƒ­ã‚¤
make deploy
```

### æ©Ÿæ¢°å­¦ç¿’ (`ml-v2/`)

```bash
# ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
make format

# å‹ãƒã‚§ãƒƒã‚¯
make mypy

# ãƒ†ã‚¹ãƒˆ
make test

# Docker ãƒ“ãƒ«ãƒ‰ & ãƒ‡ãƒ—ãƒ­ã‚¤
make deploy
```

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤

### 1. ECR ãƒªãƒã‚¸ãƒˆãƒªã®ä½œæˆ
```bash
cd iac-v2
make deploy-ecr
```

### 2. Lambda ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ—ãƒƒã‚·ãƒ¥
```bash
cd lambda
./deploy.sh
```

### 3. Step Functions ã¨ã‚¤ãƒ³ãƒ•ãƒ©ã®ãƒ‡ãƒ—ãƒ­ã‚¤
```bash
cd iac-v2
make deploy
```

### 4. æ©Ÿæ¢°å­¦ç¿’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤
```bash
cd ml-v2
make deploy
```

## âš™ï¸ è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³  

### ãƒ¬ã‚·ãƒ”ç”Ÿæˆè¨­å®š
- ãƒ¢ãƒ‡ãƒ«: GPT-4.1
- Temperature: 0.8 (å‰µé€ æ€§ã‚’é«˜ã‚ã‚‹)
- Top-p: 0.8
- Frequency/Presence penalty: 0.5/0.8 (å¤šæ§˜æ€§ã‚’ä¿ƒé€²)

### ç”»åƒç”Ÿæˆè¨­å®š
- DALL-E 3: é«˜å“è³ªãªæ–™ç†ç”»åƒç”Ÿæˆ
- Stable Diffusion: ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
- è§£åƒåº¦: 1024x1024 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)

### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
- å®Ÿè¡Œé »åº¦: 12æ™‚é–“ã”ã¨
- EventBridge ãƒ«ãƒ¼ãƒ«ã§è‡ªå‹•ãƒˆãƒªã‚¬ãƒ¼

## ğŸ“Š ç›£è¦–ã¨ãƒ­ã‚°

- **CloudWatch Logs**: å„ Lambda é–¢æ•°ã®ãƒ­ã‚°
- **Step Functions**: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒçŠ¶æ³ã®å¯è¦–åŒ–
- **X-Ray**: åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚° (æœ‰åŠ¹åŒ–ã•ã‚ŒãŸå ´åˆ)

## ğŸ¤ ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³

1. ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ•ã‚©ãƒ¼ã‚¯
2. ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ (`git checkout -b feature/amazing-feature`)
3. å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ (`git commit -m 'Add amazing feature'`)
4. ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ (`git push origin feature/amazing-feature`)
5. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ

### é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

- **ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«**: Black (Python), Biome (TypeScript)
- **å‹ãƒã‚§ãƒƒã‚¯**: mypy (Python), TypeScript
- **ãƒ†ã‚¹ãƒˆ**: pytest (Python), Jest (TypeScript)
- **ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: Conventional Commits å½¢å¼ã‚’æ¨å¥¨

## ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ MIT ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®ä¸‹ã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

1. **OpenAI API ã‚¨ãƒ©ãƒ¼**
   - API ã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«é”ã—ã¦ã„ãªã„ã‹ç¢ºèª

2. **AWS æ¨©é™ã‚¨ãƒ©ãƒ¼**
   - IAM ãƒ­ãƒ¼ãƒ«ã«å¿…è¦ãªæ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèª
   - SSM ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèª

3. **Docker ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼**
   - Docker ãƒ‡ãƒ¼ãƒ¢ãƒ³ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª
   - ECR ãƒªãƒã‚¸ãƒˆãƒªãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### ãƒ‡ãƒãƒƒã‚°

```bash
# Lambda é–¢æ•°ã®ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œ
cd lambda/src/gen_text
python handler.py

# Step Functions ã®å®Ÿè¡Œãƒ­ã‚°ç¢ºèª
aws logs describe-log-groups --log-group-name-prefix "/aws/stepfunctions/"
```

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

è³ªå•ã‚„å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ã€GitHub Issues ã§ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚

---

**Musabi** - AI-Powered Recipe & Content Creation System